name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

env:
  # Nome da imagem no GitHub Container Registry (será convertido para minúsculas)
  IMAGE_NAME: ghcr.io/${{ github.repository }}/minha-imagem-ci

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build e Push da imagem Docker
        run: |
          IMAGE=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          docker build -t $IMAGE:latest .
          docker push $IMAGE:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Criar arquivo da chave privada
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Deploy na EC2
        run: |
          IMAGE=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            # Login no GHCR
            docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.GHCR_TOKEN }}

            # Baixar a versão mais recente da imagem
            docker pull $IMAGE:latest

            # Parar e remover container antigo, se existir
            docker stop app || true && docker rm app || true

            # Rodar o container na porta 80
            docker run -d --name app -p 80:3000 $IMAGE:latest
          EOF
